"use client";
import { useEffect, useMemo, useState } from "react";
import { ethers } from "ethers";
import { FilmRegistryABI } from "@/abi/FilmRegistryABI";
import { FilmRegistryAddresses } from "@/abi/FilmRegistryAddresses";
import { LicenseManagerABI } from "@/abi/LicenseManagerABI";
import { LicenseManagerAddresses } from "@/abi/LicenseManagerAddresses";
import { RevenueManagerABI } from "@/abi/RevenueManagerABI";
import { RevenueManagerAddresses } from "@/abi/RevenueManagerAddresses";
import { useFhevm } from "@/fhevm/useFhevm";
import Sidebar from "@/components/Sidebar";
import TopBar from "@/components/TopBar";
import FilmCard from "@/components/FilmCard";

function getByChain<T extends { [k: string]: any }>(map: T, chainId?: number) {
  if (!chainId) return undefined;
  const entry = map[chainId.toString() as keyof T];
  if (!entry || !("address" in entry)) return undefined;
  return entry.address as `0x${string}`;
}

export default function HomePage() {
  const [provider, setProvider] = useState<any>();
  const [eip1193, setEip1193] = useState<any>();
  const [chainId, setChainId] = useState<number>();
  const [signer, setSigner] = useState<ethers.JsonRpcSigner>();
  const [account, setAccount] = useState<string>();
  const [activeTab, setActiveTab] = useState<'explore' | 'register' | 'dashboard'>('explore');

  useEffect(() => {
    if (typeof window !== "undefined" && (window as any).ethereum) {
      setEip1193((window as any).ethereum);
      const p = new ethers.BrowserProvider((window as any).ethereum);
      setProvider(p);
      p.getNetwork().then(n => setChainId(Number(n.chainId)));
      p.send("eth_requestAccounts", []).then(async () => {
        const s = await p.getSigner();
        setSigner(s);
        setAccount(await s.getAddress());
      });
      (window as any).ethereum.on?.("chainChanged", () => window.location.reload());
      (window as any).ethereum.on?.("accountsChanged", () => window.location.reload());
    }
  }, []);

  const { instance, status, error } = useFhevm({
    provider: eip1193,
    chainId,
    // Âº∫Âà∂Ëµ∞ Sepolia Relayer SDK Ë∑ØÂæÑÔºåÈÅøÂÖçËØØËß¶ÂèëÊú¨Âú∞ Mock
    initialMockChains: {},
    enabled: Boolean(eip1193)
  });

  const addresses = useMemo(() => ({
    registry: getByChain(FilmRegistryAddresses, chainId),
    license: getByChain(LicenseManagerAddresses, chainId),
    revenue: getByChain(RevenueManagerAddresses, chainId)
  }), [chainId]);

  const [title, setTitle] = useState("");
  const [metaCid, setMetaCid] = useState("");
  const [videoFile, setVideoFile] = useState<File | null>(null);
  const [hashUintStr, setHashUintStr] = useState("");
  const [message, setMessage] = useState("");
  const [loading, setLoading] = useState(false);
  const [filmId, setFilmId] = useState<number>();
  const [balanceHandle, setBalanceHandle] = useState<string | undefined>(undefined);
  const [clearBalance, setClearBalance] = useState<string | undefined>(undefined);
  const [myFilms, setMyFilms] = useState<Array<{ filmId: number; title: string; ipfsCidMeta: string; createdAt: bigint; owner?: string }>>([]);
  const [exploreFilms, setExploreFilms] = useState<Array<{ filmId: number; title: string; owner: string }>>([]);
  const [licensePrice, setLicensePrice] = useState<string>("0.001");
  const [createdCount, setCreatedCount] = useState<number>(0);
  const [licensedCount, setLicensedCount] = useState<number>(0);
  const [earningBalance, setEarningBalance] = useState<string>("0");
  const [withdrawFilmId, setWithdrawFilmId] = useState<number>(0);
  const [withdrawAmount, setWithdrawAmount] = useState<string>("");

  // ÈÄâÊã©ËßÜÈ¢ëÂêéÔºåÁ´ãÂç≥ËÆ°ÁÆó SHA-256 Âπ∂Â°´ÂÖ•
  const onSelectVideo = async (file: File | null) => {
    setVideoFile(file);
    if (!file) {
      setHashUintStr("");
      return;
    }
    try {
      setLoading(true);
      setMessage('üßÆ Ê≠£Âú®ËÆ°ÁÆóËßÜÈ¢ëÂìàÂ∏å...');
      const ab = await file.arrayBuffer();
      const buf = await crypto.subtle.digest('SHA-256', ab);
      const hex = Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
      const uintStr = BigInt('0x' + hex).toString();
      setHashUintStr(uintStr);
      setMessage('‚úÖ Â∑≤ËÆ°ÁÆóËßÜÈ¢ëÂìàÂ∏å');
    } catch (e:any) {
      setMessage('‚ùå ÂìàÂ∏åËÆ°ÁÆóÂ§±Ë¥•: ' + e.message);
      setHashUintStr("");
    } finally {
      setLoading(false);
    }
  };

  const normalizeCid = (value: string) => {
    if (!value) return "";
    let s = value.trim();
    if (s.startsWith("ipfs://")) s = s.slice(7);
    s = s.replace(/^https?:\/\/[^/]+\/ipfs\//, "");
    s = s.replace(/^\/ipfs\//, "");
    return s;
  };

  const looksLikeCid = (value: string) => {
    const s = normalizeCid(value);
    return s.length > 30 && /^[a-zA-Z0-9]+$/.test(s);
  };

  const register = async () => {
    if (!instance || !signer || !addresses.registry || !account) return;
    if (!videoFile) { setMessage('ËØ∑ÈÄâÊã©ËßÜÈ¢ëÊñá‰ª∂'); return; }
    setLoading(true);
    setMessage("üì¶ Ê≠£Âú®‰∏ä‰º†ËßÜÈ¢ëÂà∞ Pinata...");
    try {
      // 1) ‰∏ä‰º†ËßÜÈ¢ë
      const fd = new FormData();
      fd.append('file', videoFile);
      const up = await fetch('/api/pinata/upload', { method: 'POST', body: fd });
      if (!up.ok) throw new Error(await up.text());
      const upJson = await up.json();
      const videoCid = upJson.cid as string;

      // 2) ËÆ°ÁÆóËßÜÈ¢ëÂìàÂ∏å
      setMessage('üßÆ Ê≠£Âú®ËÆ°ÁÆóËßÜÈ¢ëÂìàÂ∏å...');
      const ab = await videoFile.arrayBuffer();
      const buf = await crypto.subtle.digest('SHA-256', ab);
      const hex = Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
      const uintStr = BigInt('0x' + hex).toString();
      setHashUintStr(uintStr);

      // 3) ÁîüÊàê metadata.json Âπ∂ pin
      setMessage('üßæ ÁîüÊàêÂÖÉÊï∞ÊçÆÂπ∂ Pin...');
      const meta = {
        title,
        description: 'Uploaded via ChainFilm',
        video: `ipfs://${videoCid}`,
        timestamp: Math.floor(Date.now()/1000)
      };
      const pj = await fetch('/api/pinata/pinjson', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(meta) });
      if (!pj.ok) throw new Error(await pj.text());
      const pjJson = await pj.json();
      const normalizedCid = pjJson.cid as string; // use metadata cid

      // 4) ‰∏äÈìæ
      setMessage('üîê Ê≠£Âú®Âä†ÂØÜÂΩ±Áâá‰ø°ÊÅØÂπ∂‰∏äÈìæ...');
      const input = instance.createEncryptedInput(addresses.registry, account);
      input.add256(BigInt(uintStr));
      const enc = await input.encrypt();
      const contract = new ethers.Contract(addresses.registry, FilmRegistryABI.abi, signer);
      const tx = await contract.registerFilm(title, normalizedCid, enc.handles[0], enc.inputProof, [account], [10000]);
      setMessage("‚è≥ Á≠âÂæÖ‰∫§ÊòìÁ°ÆËÆ§...");
      const rc = await tx.wait();
      setMessage("‚úÖ ÂΩ±ÁâáÊ≥®ÂÜåÊàêÂäüÔºÅ");
      try {
        const l = await signer.provider!.getLogs({ address: addresses.registry, fromBlock: rc!.blockNumber, toBlock: rc!.blockNumber });
        const fid = Number(l[0]?.topics[1]);
        setFilmId(fid);
        setMessage(`‚úÖ ÂΩ±ÁâáÂ∑≤Ê≥®ÂÜåÔºåFilmID: ${fid}`);
      } catch {}
      setTitle("");
      setMetaCid("");
      setHashUintStr("");
    } catch (e: any) {
      setMessage(`‚ùå Ê≥®ÂÜåÂ§±Ë¥•: ${e.message}`);
    } finally {
      setLoading(false);
    }
  };

  const purchase = async (fid: number) => {
    if (!signer || !addresses.license || !addresses.registry) return;
    setLoading(true);
    setMessage("üí≥ Ê≠£Âú®Ë¥≠‰π∞ÊéàÊùÉ...");
    try {
      const lic = new ethers.Contract(addresses.license, LicenseManagerABI.abi, signer);
      const reg = new ethers.Contract(addresses.registry, FilmRegistryABI.abi, signer);

      // 1) È¢ÑÊ£Ä‰ΩúÂìÅÊòØÂê¶Â≠òÂú®
      const f = await reg.films(fid);
      if (!f || !f.exists) {
        setMessage(`‚ùå Ë¥≠‰π∞Â§±Ë¥•Ôºö‰ΩúÂìÅ #${fid} ‰∏çÂ≠òÂú®`);
        setLoading(false);
        return;
      }

      // 2) ËØªÂèñ‰ª∑Ê†ºÔºàÈÅøÂÖç‰∏éÂêàÁ∫¶ÈÖçÁΩÆ‰∏ç‰∏ÄËá¥Ôºâ
      const price: bigint = (await lic.basePriceWei?.().catch(() => null)) ?? ethers.parseEther("0.001");
      setLicensePrice(ethers.formatEther(price));

      // 3) ÂÖàÂÅöÈùôÊÄÅË∞ÉÁî®ÔºåÊãøÂà∞Êõ¥Ê∏ÖÊô∞ÁöÑ revert ÂéüÂõ†
      try {
        await lic.purchaseLicense.staticCall(fid, { value: price });
      } catch (err: any) {
        const msg = String(err?.reason || err?.shortMessage || err?.message || 'unknown error');
        // Êüê‰∫õ Sepolia ËäÇÁÇπÂú® staticCall/estimateGas ‰∏çËøîÂõû revert Êï∞ÊçÆ
        // Â¶ÇÊûúÂè™ÊòØ "missing revert data"ÔºåÁªßÁª≠Â∞ùËØïÁõ¥Êé•ÂèëÈÄÅ‰∫§Êòì
        if (!/missing revert data/i.test(msg)) {
          setMessage(`‚ùå Ë¥≠‰π∞ÂâçÊ£ÄÊü•Â§±Ë¥•: ${msg}`);
          setLoading(false);
          return;
        }
      }

      // 4) Ê≠£ÂºèÂèëÈÄÅ‰∫§Êòì
      // 4) ‰º∞ÁÆó gasÔºõÂ¶ÇÊûúËäÇÁÇπ‰∏çÁªôÂá∫ÂéüÂõ†ÔºåËÆæÁΩÆ‰∏Ä‰∏™‰øùÂÆàÁöÑ gasLimit ‰ª•ÈÅøÂÖç estimateGas Êä•Èîô
      let gasLimit: bigint | undefined = undefined;
      try {
        gasLimit = await lic.purchaseLicense.estimateGas(fid, { value: price });
      } catch {}
      const tx = await lic.purchaseLicense(fid, { value: price, gasLimit: gasLimit ?? 300000n });
      setMessage("‚è≥ Á≠âÂæÖ‰∫§ÊòìÁ°ÆËÆ§...");
      await tx.wait();
      setMessage(`‚úÖ ÊéàÊùÉË¥≠‰π∞ÊàêÂäüÔºÅFilmID: ${fid}`);
      // Ë¥≠‰π∞ÊàêÂäüÂêéÂª∫ËÆÆË∑≥ËΩ¨Âà∞Êí≠ÊîæÈ°µ
      window.open(`/watch/${fid}`, '_blank');
    } catch (e: any) {
      setMessage(`‚ùå Ë¥≠‰π∞Â§±Ë¥•: ${e?.reason || e?.shortMessage || e.message}`);
    } finally {
      setLoading(false);
    }
  };

  const fetchEncBalance = async () => {
    if (!provider || !addresses.revenue || !filmId || !account) return;
    setLoading(true);
    setMessage("üì° ËØªÂèñÂä†ÂØÜ‰ΩôÈ¢ùÂè•ÊüÑ...");
    try {
      const ro = new ethers.Contract(addresses.revenue, RevenueManagerABI.abi, provider);
      const handle = await ro.getBalanceHandle(filmId, account);
      setBalanceHandle(handle);
      setMessage(`‚úÖ Â∑≤Ëé∑ÂèñÂä†ÂØÜ‰ΩôÈ¢ùÂè•ÊüÑ`);
    } catch (e: any) {
      setMessage(`‚ùå ËØªÂèñÂ§±Ë¥•: ${e.message}`);
    } finally {
      setLoading(false);
    }
  };

  const decryptBalance = async () => {
    if (!instance || !addresses.revenue || !balanceHandle || !signer || !account) return;
    setLoading(true);
    setMessage("üîì Ê≠£Âú®Ëß£ÂØÜ‰ΩôÈ¢ù...");
    try {
      const kp = instance.generateKeypair();
      const eip = instance.createEIP712(kp.publicKey, [addresses.revenue], Math.floor(Date.now()/1000), 365);
      const sig = await signer.signTypedData(eip.domain, { UserDecryptRequestVerification: eip.types.UserDecryptRequestVerification }, eip.message);
      const res = await instance.userDecrypt(
        [{ handle: balanceHandle, contractAddress: addresses.revenue }],
        kp.privateKey,
        kp.publicKey,
        sig,
        [addresses.revenue],
        account as `0x${string}`,
        eip.message.startTimestamp,
        365
      );
      const bal = String(res[balanceHandle]);
      setClearBalance(bal);
      setMessage(`‚úÖ Ëß£ÂØÜÊàêÂäüÔºÅ‰ΩôÈ¢ù: ${ethers.formatEther(bal)} ETH`);
    } catch (e: any) {
      setMessage(`‚ùå Ëß£ÂØÜÂ§±Ë¥•: ${e.message}`);
    } finally {
      setLoading(false);
    }
  };

  // Load "My Films" by reading FilmRegistered events and then fetching details
  useEffect(() => {
    const run = async () => {
      if (!provider || !addresses.registry || !account) return;
      try {
        const reg = new ethers.Contract(addresses.registry, FilmRegistryABI.abi, provider);
        // ethers v6: create filter by event name
        const filter = (reg as any).filters?.FilmRegistered?.(null, account) || {
          address: addresses.registry,
          topics: [ethers.id("FilmRegistered(uint256,address)"), null, ethers.zeroPadValue(account, 32)]
        };
        const logs = await (reg as any).queryFilter ? await (reg as any).queryFilter(filter, 0n, "latest") : await provider.getLogs({ fromBlock: 0n, toBlock: "latest", ...filter });

        const filmIds: number[] = [];
        for (const l of logs) {
          const parsed = (reg as any).interface?.parseLog ? (reg as any).interface.parseLog(l) : null;
          const fid = Number(parsed ? parsed.args[0] : BigInt(l.topics[1]));
          if (!filmIds.includes(fid)) filmIds.push(fid);
        }

        const results: Array<{ filmId: number; title: string; ipfsCidMeta: string; createdAt: bigint; owner?: string }> = [];
        for (const fid of filmIds) {
          try {
            const f = await reg.films(fid);
            // tuple: owner, title, ipfsCidMeta, <bytes>, collaborators, sharesBps, createdAt, exists
            if (f && f.exists) {
              results.push({ filmId: fid, title: String(f.title), ipfsCidMeta: String(f.ipfsCidMeta), createdAt: BigInt(f.createdAt), owner: String(f.owner) });
            }
          } catch {}
        }
        setMyFilms(results);
        setCreatedCount(results.length);
      } catch {}
    };
    run();
  }, [provider, addresses.registry, account]);

  // Load Explore films (all owners)
  useEffect(() => {
    const run = async () => {
      if (!provider || !addresses.registry) return;
      try {
        const reg = new ethers.Contract(addresses.registry, FilmRegistryABI.abi, provider);
        // read price from license manager if available
        if (addresses.license) {
          try {
            const lic = new ethers.Contract(addresses.license, LicenseManagerABI.abi, provider);
            const p = await (lic as any).basePriceWei?.();
            if (p) setLicensePrice(ethers.formatEther(p));
          } catch {}
        }
        const filter = (reg as any).filters?.FilmRegistered?.(null, null) || {
          address: addresses.registry,
          topics: [ethers.id("FilmRegistered(uint256,address)"), null, null]
        };
        const logs = await (reg as any).queryFilter ? await (reg as any).queryFilter(filter, 0n, "latest") : await provider.getLogs({ fromBlock: 0n, toBlock: "latest", ...filter });

        // Keep most recent 12
        const last = logs.slice(-12).reverse();
        const items: Array<{ filmId: number; title: string; owner: string }> = [];
        for (const l of last) {
          try {
            const parsed = (reg as any).interface?.parseLog ? (reg as any).interface.parseLog(l) : null;
            const fid = Number(parsed ? parsed.args[0] : BigInt(l.topics[1]));
            const f = await reg.films(fid);
            if (f && f.exists) {
              items.push({ filmId: fid, title: String(f.title), owner: String(f.owner) });
            }
          } catch {}
        }
        setExploreFilms(items);
      } catch {}
    };
    run();
  }, [provider, addresses.registry]);

  // Load licensed count (number of films you purchased)
  useEffect(() => {
    const run = async () => {
      if (!provider || !addresses.license || !account) return;
      try {
        const lic = new ethers.Contract(addresses.license, LicenseManagerABI.abi, provider);
        const filter = (lic as any).filters?.Purchased?.(null, account) || {
          address: addresses.license,
          topics: [ethers.id("Purchased(uint256,address,uint256)"), null, ethers.zeroPadValue(account, 32)]
        };
        const logs = await (lic as any).queryFilter ? await (lic as any).queryFilter(filter, 0n, "latest") : await provider.getLogs({ fromBlock: 0n, toBlock: "latest", ...filter });
        const filmSet = new Set<number>();
        for (const l of logs) {
          const parsed = (lic as any).interface?.parseLog ? (lic as any).interface.parseLog(l) : null;
          const fid = Number(parsed ? parsed.args[0] : BigInt(l.topics[1]));
          filmSet.add(fid);
        }
        setLicensedCount(filmSet.size);
      } catch {}
    };
    run();
  }, [provider, addresses.license, account]);

  // Load earning balance from RevenueManager (Êî∂Áõä‰ΩôÈ¢ùÔºåÂèØÊèêÁé∞)
  useEffect(() => {
    const run = async () => {
      if (!provider || !addresses.revenue || !account) return;
      try {
        const minimalAbi = [
          'function getUserAvailable(address user) view returns (uint256)'
        ];
        const revenueReader = new ethers.Contract(
          addresses.revenue,
          minimalAbi,
          provider
        );
        const wei: bigint = await revenueReader.getUserAvailable(account);
        setEarningBalance(ethers.formatEther(wei));
      } catch {
        setEarningBalance("0");
      }
    };
    run();
  }, [provider, addresses.revenue, account]);

  const withdraw = async () => {
    if (!addresses.revenue || !signer) return;
    try {
      setMessage("‚è≥ ÂèëËµ∑ÊèêÁé∞...");
      const abi = ['function withdraw(uint256 filmId, uint256 amountWei)'];
      const revenue = new ethers.Contract(addresses.revenue, abi, signer);
      const wei = ethers.parseEther(withdrawAmount || '0');
      const tx = await revenue.withdraw(withdrawFilmId, wei);
      await tx.wait();
      setMessage("‚úÖ ÊèêÁé∞ÂÆåÊàê");
    } catch (e: any) {
      setMessage(`‚ùå ÊèêÁé∞Â§±Ë¥•: ${e?.shortMessage || e?.message}`);
    }
  };

  if (!account) {
    return (
      <div style={{
        minHeight: '100vh',
        display: 'flex',
        flexDirection: 'column',
        alignItems: 'center',
        justifyContent: 'center',
        textAlign: 'center',
        background: 'radial-gradient(circle at 50% 0%, rgba(212, 175, 55, 0.15), transparent 50%)',
      }}>
        <div style={{
          background: 'var(--gradient-gold)',
          WebkitBackgroundClip: 'text',
          WebkitTextFillColor: 'transparent',
          fontSize: 120,
          marginBottom: 32,
          animation: 'fadeIn 1s ease-out'
        }}>
          üé¨
        </div>
        <h1 style={{ fontSize: 64, marginBottom: 16, fontWeight: 900 }}>
          <span className="gold-text">ChainFilm</span>
        </h1>
        <p style={{ fontSize: 20, color: 'var(--text-secondary)', marginBottom: 48, maxWidth: 500, lineHeight: 1.6 }}>
          Âü∫‰∫é FHEVM ÁöÑÂéª‰∏≠ÂøÉÂåñÂæÆÁîµÂΩ±ÁâàÊùÉÁ≥ªÁªü<br/>
          ÊØè‰∏ÄÂ∏ßÂΩ±ÂÉèÔºåÈÉΩÂÄºÂæóË¢´ËÆ∞ÂΩï
        </p>
        <button 
          className="btn-primary" 
          style={{ fontSize: 18, padding: '18px 48px' }}
          onClick={() => {
            if ((window as any).ethereum) {
              (window as any).ethereum.request({ method: 'eth_requestAccounts' });
            }
          }}
        >
          üîó ËøûÊé• MetaMask Èí±ÂåÖ
        </button>
        <div style={{
          marginTop: 60,
          display: 'flex',
          gap: 40,
          color: 'var(--text-secondary)',
          fontSize: 14
        }}>
          <div>üîê ÂÆåÂÖ®ÈöêÁßÅ</div>
          <div>‚ö° Èìæ‰∏äÂ≠òËØÅ</div>
          <div>üí∞ Ëá™Âä®ÂàÜÊ∂¶</div>
        </div>
      </div>
    );
  }

  return (
    <div style={{ display: 'flex', minHeight: '100vh' }}>
      <Sidebar activeTab={activeTab} onTabChange={(tab) => setActiveTab(tab as any)} />
      
      <div style={{ marginLeft: 280, flex: 1, display: 'flex', flexDirection: 'column' }}>
        <TopBar account={account} chainId={chainId} status={status} />

        <main style={{ flex: 1, padding: '40px 60px', overflowY: 'auto' }}>
          {activeTab === 'explore' && (
            <div className="fade-in">
              {/* Hero Banner */}
              <div style={{
                background: 'linear-gradient(135deg, rgba(212, 175, 55, 0.2), rgba(10, 14, 26, 0.8))',
                borderRadius: 24,
                padding: '60px 48px',
                marginBottom: 48,
                border: '1px solid var(--border-color)',
                position: 'relative',
                overflow: 'hidden'
              }}>
                <div style={{
                  position: 'absolute',
                  top: 0,
                  right: 0,
                  fontSize: 200,
                  opacity: 0.1,
                  transform: 'rotate(15deg)',
                  lineHeight: 1
                }}>
                  üé¨
                </div>
                <h1 style={{ fontSize: 48, marginBottom: 16, fontWeight: 900, position: 'relative', zIndex: 1 }}>
                  Êé¢Á¥¢<span className="gold-text">‰ºòË¥®ÂΩ±Áâá</span>
                </h1>
                <p style={{ fontSize: 18, color: 'var(--text-secondary)', maxWidth: 600, position: 'relative', zIndex: 1 }}>
                  Èìæ‰∏äÁâàÊùÉ‰øùÊä§ÔºåÂÆåÂÖ®ÈÄèÊòéÂàÜÊ∂¶ÔºåÊØè‰∏ÄÊ¨°Êí≠ÊîæÈÉΩÊúâËÆ∞ÂΩï
                </p>
              </div>

              {/* Filter Bar */}
              <div style={{
                display: 'flex',
                gap: 16,
                marginBottom: 32,
                flexWrap: 'wrap'
              }}>
                {['üî• ÁÉ≠Èó®', '‚≠ê ÊúÄÊñ∞', 'üìä ËØÑÂàÜÊúÄÈ´ò', 'üëÄ ËßÇÁúãÊúÄÂ§ö'].map(filter => (
                  <button
                    key={filter}
                    className="btn-secondary"
                    style={{ padding: '12px 24px' }}
                  >
                    {filter}
                  </button>
                ))}
              </div>

              {/* Film Grid - from chain */}
              {exploreFilms.length === 0 ? (
                <div style={{ color: 'var(--text-secondary)', fontSize: 14 }}>ÊöÇÊó†‰∏äÈìæÂΩ±ÁâáÔºåÂéª‚Äú‰∏ä‰º†‰ΩúÂìÅ‚ÄùÂèëÂ∏É‰Ω†ÁöÑÁ¨¨‰∏ÄÈÉ®ÂΩ±ÁâáÂêß„ÄÇ</div>
              ) : (
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(340px, 1fr))', gap: 32 }}>
                  {exploreFilms.map((it) => (
                    <FilmCard
                      key={it.filmId}
                      title={it.title || `Film #${it.filmId}`}
                      author={it.owner.slice(0, 6) + '...' + it.owner.slice(-4)}
                      rating={8.0}
                      reviews={0}
                      onPurchase={() => purchase(it.filmId)}
                    />
                  ))}
                </div>
              )}
              <div style={{ color: 'var(--text-secondary)', marginTop: 12, fontSize: 12 }}>
                ÂΩìÂâçÈìæ‰∏äÊéàÊùÉ‰ª∑Ê†ºÔºö{licensePrice} ETH
              </div>
            </div>
          )}

          {activeTab === 'register' && (
            <div className="fade-in">
              <h1 style={{ fontSize: 42, marginBottom: 48, fontWeight: 900 }}>
                ‰∏ä‰º†<span className="gold-text">Êñ∞‰ΩúÂìÅ</span>
              </h1>

              <div style={{ display: 'grid', gridTemplateColumns: '1fr 400px', gap: 48 }}>
                {/* Form */}
                <div className="card" style={{ padding: 40 }}>
                  <div style={{ display: 'flex', flexDirection: 'column', gap: 28 }}>
                    <div>
                      <label style={{ 
                        display: 'block', 
                        marginBottom: 12, 
                        fontWeight: 600,
                        fontSize: 15,
                        color: 'var(--text-primary)'
                      }}>
                        üìù ÂΩ±ÁâáÊ†áÈ¢ò
                      </label>
                      <input 
                        className="input-field" 
                        placeholder="Áªô‰Ω†ÁöÑ‰ΩúÂìÅËµ∑‰∏™Âìç‰∫ÆÁöÑÂêçÂ≠ó" 
                        value={title} 
                        onChange={e=>setTitle(e.target.value)}
                        style={{ fontSize: 16 }}
                      />
                    </div>

                    <div>
                      <label style={{ display: 'block', marginBottom: 12, fontWeight: 600, fontSize: 15 }}>
                        üì¶ ÈÄâÊã©ËßÜÈ¢ëÔºàËá™Âä®‰∏ä‰º†Âà∞ Pinata Âπ∂ÁîüÊàêÂÖÉÊï∞ÊçÆÔºâ
                      </label>
                      <input type="file" accept="video/*" className="input-field" style={{ padding: 10 }} onChange={(e)=>onSelectVideo(e.target.files?.[0] ?? null)} />
                      <div style={{ marginTop: 10, fontSize: 12, color: 'var(--text-secondary)' }}>
                        ÈÄâÊã©ËßÜÈ¢ëÊñá‰ª∂ÂêéÔºåÁÇπÂáª‚ÄúÁ´ãÂç≥Ê≥®ÂÜå‰∏äÈìæ‚ÄùÂ∞ÜËá™Âä®‰∏ä‰º†Âπ∂ÁîüÊàê metadata.json
                      </div>
                    </div>

                    <div>
                      <label style={{ display: 'block', marginBottom: 12, fontWeight: 600, fontSize: 15 }}>
                        üîê ËßÜÈ¢ëÂìàÂ∏å (Ëá™Âä®ËÆ°ÁÆó)
                      </label>
                      <input className="input-field" placeholder="ÈÄâÊã©ËßÜÈ¢ëÂêéÂèØËá™Âä®ËÆ°ÁÆóÔºåÊó†ÈúÄÊâãÂ°´" value={hashUintStr} readOnly />
                      <div style={{
                        marginTop: 12,
                        padding: 16,
                        background: 'rgba(255,255,255,0.04)',
                        border: '1px solid var(--border-color)',
                        borderRadius: 8,
                        fontSize: 12,
                        color: 'var(--text-secondary)',
                        lineHeight: 1.6,
                        fontFamily: 'monospace'
                      }}>
                        Á§∫‰æãÂëΩ‰ª§ÔºàÂèØÂú®ÁªàÁ´ØÊâãÂä®ËÆ°ÁÆóÔºåÊµèËßàÂô®Â∑≤Ëá™Âä®ËÆ°ÁÆóÔºâÔºö
                        node -e "console.log(BigInt('0x'+require('crypto').createHash('sha256').update('video_content').digest('hex')))"
                      </div>
                    </div>

                    <button 
                      className="btn-primary" 
                      onClick={register} 
                      disabled={!addresses.registry || !instance || loading || !title || !videoFile}
                      style={{ 
                        fontSize: 17, 
                        padding: '18px 36px',
                        marginTop: 12
                      }}
                    >
                      {loading ? '‚è≥ Â§ÑÁêÜ‰∏≠...' : 'üì§ Á´ãÂç≥Ê≥®ÂÜå‰∏äÈìæ'}
                    </button>
                  </div>
                </div>

                {/* Info Panel */}
                <div>
                  <div className="card" style={{ marginBottom: 24, padding: 28 }}>
                    <h3 style={{ fontSize: 18, marginBottom: 16, fontWeight: 700 }}>
                      üîê ÈöêÁßÅ‰øùÊä§
                    </h3>
                    <ul style={{ 
                      listStyle: 'none', 
                      color: 'var(--text-secondary)', 
                      fontSize: 14,
                      lineHeight: 2
                    }}>
                      <li>‚úì ËßÜÈ¢ëÂìàÂ∏åÂÆåÂÖ®Âä†ÂØÜ</li>
                      <li>‚úì Âè™ÊúâÂàõ‰ΩúËÄÖÂèØËß£ÂØÜ</li>
                      <li>‚úì Èìæ‰∏äÁâàÊùÉÂ≠òËØÅ</li>
                      <li>‚úì Èò≤ÁØ°Êîπ‰øùÊä§</li>
                    </ul>
                  </div>

                  <div className="card" style={{ padding: 28 }}>
                    <h3 style={{ fontSize: 18, marginBottom: 16, fontWeight: 700 }}>
                      üí∞ Êî∂ÁõäÂàÜÊ∂¶
                    </h3>
                    <div style={{ 
                      background: 'rgba(212, 175, 55, 0.1)',
                      borderRadius: 12,
                      padding: 20,
                      marginBottom: 16
                    }}>
                      <div style={{ fontSize: 32, fontWeight: 900, marginBottom: 8 }}>
                        <span className="gold-text">100%</span>
                      </div>
                      <div style={{ fontSize: 13, color: 'var(--text-secondary)' }}>
                        Ëá™Âä®ÂàÜÈÖçÁªôÂàõ‰ΩúËÄÖ
                      </div>
                    </div>
                    <div style={{ fontSize: 13, color: 'var(--text-secondary)', lineHeight: 1.6 }}>
                      ÊØèÊ¨°ÊéàÊùÉË¥≠‰π∞ÂêéÔºåÊî∂Áõä‰ºöËá™Âä®ÊåâËÆæÂÆöÊØî‰æãÂàÜÈÖçÁªôÊâÄÊúâÂêà‰ΩúËÄÖ
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {activeTab === 'dashboard' && (
            <div className="fade-in">
              <h1 style={{ fontSize: 42, marginBottom: 48, fontWeight: 900 }}>
                ÊàëÁöÑ<span className="gold-text">ËµÑ‰∫ß</span>
              </h1>

              {/* Stats Cards */}
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 24, marginBottom: 48 }}>
                <div className="card" style={{ padding: 32, textAlign: 'center' }}>
                  <div style={{ fontSize: 48, marginBottom: 12 }}>üé¨</div>
                  <div style={{ fontSize: 36, fontWeight: 900, marginBottom: 8 }}>
                    <span className="gold-text">{createdCount}</span>
                  </div>
                  <div style={{ color: 'var(--text-secondary)' }}>Âàõ‰ΩúÂΩ±Áâá</div>
                </div>
                <div className="card" style={{ padding: 32, textAlign: 'center' }}>
                  <div style={{ fontSize: 48, marginBottom: 12 }}>üìú</div>
                  <div style={{ fontSize: 36, fontWeight: 900, marginBottom: 8 }}>
                    <span className="gold-text">{licensedCount}</span>
                  </div>
                  <div style={{ color: 'var(--text-secondary)' }}>ÊåÅÊúâÊéàÊùÉ</div>
                </div>
                <div className="card" style={{ padding: 32, textAlign: 'center' }}>
                  <div style={{ fontSize: 48, marginBottom: 12 }}>üí∞</div>
                  <div style={{ fontSize: 36, fontWeight: 900, marginBottom: 8 }}>
                    <span className="gold-text">{Number(earningBalance).toFixed(3)}</span>
                  </div>
                  <div style={{ color: 'var(--text-secondary)' }}>Êî∂Áõä‰ΩôÈ¢ùÔºàÂèØÊèêÁé∞Ôºâ</div>
                </div>
              </div>

              {/* Withdraw panel */}
              <div className="card" style={{ padding: 24, marginBottom: 32 }}>
                <h3 style={{ fontSize: 18, marginBottom: 12 }}>ÊèêÁé∞Âà∞Èí±ÂåÖ</h3>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr auto', gap: 12, alignItems: 'center' }}>
                  <input className="input-field" placeholder="ÂΩ±Áâá Film ID" value={withdrawFilmId || ''} onChange={(e)=>setWithdrawFilmId(Number(e.target.value))} />
                  <input className="input-field" placeholder="ÊèêÁé∞ÈáëÈ¢ù(ETH)" value={withdrawAmount} onChange={(e)=>setWithdrawAmount(e.target.value)} />
                  <button className="btn-primary" onClick={withdraw}>ÊèêÁé∞</button>
                </div>
                <div style={{ marginTop: 8, color: 'var(--text-secondary)', fontSize: 12 }}>ÂΩìÂâçÊî∂Áõä‰ΩôÈ¢ùÔºö{Number(earningBalance).toFixed(6)} ETH</div>
              </div>

              {/* Balance Query */}
              <div className="card" style={{ padding: 40, marginBottom: 32 }}>
                <h2 style={{ fontSize: 24, marginBottom: 28, fontWeight: 700 }}>
                  üí∞ Êî∂ÁõäÊü•ËØ¢‰∏éËß£ÂØÜ
                </h2>
                
                <div style={{ display: 'grid', gap: 24 }}>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr auto', gap: 16 }}>
                    <input 
                      className="input-field" 
                      placeholder="ËæìÂÖ• Film ID Êü•ËØ¢Êî∂Áõä" 
                      value={filmId ?? ""} 
                      onChange={e=>setFilmId(Number(e.target.value))}
                      style={{ fontSize: 16 }}
                    />
                    <button 
                      className="btn-secondary" 
                      onClick={fetchEncBalance} 
                      disabled={!addresses.revenue || !filmId || loading}
                      style={{ padding: '14px 32px', whiteSpace: 'nowrap' }}
                    >
                      üì° ËØªÂèñÂØÜÊñá‰ΩôÈ¢ù
                    </button>
                  </div>

                  {balanceHandle && (
                    <>
                      <div style={{ 
                        background: 'rgba(212, 175, 55, 0.05)', 
                        border: '1px solid var(--gold-primary)', 
                        borderRadius: 12, 
                        padding: 24 
                      }}>
                        <div style={{ fontSize: 13, color: 'var(--text-secondary)', marginBottom: 8, fontWeight: 600 }}>
                          üîê Âä†ÂØÜÂè•ÊüÑ
                        </div>
                        <div style={{ 
                          fontFamily: 'monospace', 
                          fontSize: 13, 
                          wordBreak: 'break-all',
                          color: 'var(--gold-primary)',
                          lineHeight: 1.8
                        }}>
                          {balanceHandle}
                        </div>
                      </div>

                      <button 
                        className="btn-primary" 
                        onClick={decryptBalance} 
                        disabled={!instance || loading}
                        style={{ fontSize: 17, padding: '18px 36px' }}
                      >
                        {loading ? '‚è≥ Ëß£ÂØÜ‰∏≠...' : 'üîì Ëß£ÂØÜÊü•ÁúãÊòéÊñá‰ΩôÈ¢ù'}
                      </button>
                    </>
                  )}
                </div>
              </div>

              {/* My Films */}
              <div className="card" style={{ padding: 40 }}>
                <h2 style={{ fontSize: 24, marginBottom: 24, fontWeight: 700 }}>
                  üìã ÊàëÂàõ‰ΩúÁöÑÂΩ±Áâá
                </h2>
                {myFilms.length === 0 ? (
                  <div style={{ 
                    textAlign: 'center', 
                    padding: '60px 20px',
                    color: 'var(--text-secondary)'
                  }}>
                    <div style={{ fontSize: 64, marginBottom: 16, opacity: 0.3 }}>üé¨</div>
                    <div style={{ fontSize: 16 }}>ÊöÇÊó†ÂΩ±ÁâáÊï∞ÊçÆ</div>
                    <div style={{ fontSize: 14, marginTop: 8 }}>Âéª"‰∏ä‰º†‰ΩúÂìÅ"È°µÈù¢Ê≥®ÂÜå‰Ω†ÁöÑÁ¨¨‰∏ÄÈÉ®ÂΩ±ÁâáÂêßÔºÅ</div>
                  </div>
                ) : (
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(320px, 1fr))', gap: 24 }}>
                    {myFilms.map(f => (
                      <div key={f.filmId} className="card" style={{ padding: 20 }}>
                        <div style={{ fontSize: 12, color: 'var(--text-secondary)' }}>Film ID: {f.filmId}</div>
                        <div style={{ fontSize: 18, fontWeight: 700, margin: '8px 0 6px' }}>{f.title || 'Êú™ÂëΩÂêç'}</div>
                        <div style={{ fontFamily: 'monospace', fontSize: 12, wordBreak: 'break-all', color: 'var(--text-secondary)' }}>{f.ipfsCidMeta}</div>
                        <div style={{ marginTop: 10, fontSize: 12, color: 'var(--text-secondary)' }}>ÂàõÂª∫Êó∂Èó¥: {new Date(Number(f.createdAt) * 1000).toLocaleString()}</div>
                        <div style={{ marginTop: 12, display: 'flex', gap: 10 }}>
                          <button className="btn-secondary" onClick={() => setFilmId(f.filmId)}>Êü•ËØ¢Êî∂Áõä</button>
                          <button className="btn-primary" onClick={() => {
                            const cid = normalizeCid(f.ipfsCidMeta);
                            if (!looksLikeCid(cid)) { setMessage('‚ùå ÂÖÉÊï∞ÊçÆ CID Êó†ÊïàÔºåÊó†Ê≥ïÊâìÂºÄ'); return; }
                            const url = `https://ipfs.io/ipfs/${cid}`;
                            window.open(url, '_blank');
                          }}>ÊâìÂºÄÂÖÉÊï∞ÊçÆ</button>
                          <button className="btn-secondary" onClick={() => window.open(`/watch/${f.filmId}`, '_blank')}>Êí≠Êîæ</button>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
          )}
        </main>
      </div>

      {/* Toast Notification - only show errors */}
      {message && (/^‚ùå|Â§±Ë¥•|error|ÈîôËØØ/i.test(message)) && (
        <div style={{
          position: 'fixed',
          bottom: 40,
          right: 40,
          background: 'var(--bg-card)',
          border: '1px solid var(--gold-primary)',
          borderRadius: 16,
          padding: '20px 28px',
          maxWidth: 450,
          boxShadow: '0 8px 32px rgba(212, 175, 55, 0.4)',
          zIndex: 1000,
          animation: 'fadeIn 0.3s ease-out',
          fontSize: 15,
          lineHeight: 1.6
        }}>
          {message}
        </div>
      )}
    </div>
  );
}
